## ğŸ“‹ ì£¼ë¬¸ ì²˜ë¦¬ í”Œë¡œìš°

### 1. ì •ìƒ ì£¼ë¬¸ ì²˜ë¦¬ - ê²°ì œ ìš”ì²­

```mermaid
sequenceDiagram autonumber
    participant Frontend
    participant Order
    participant Product
    participant Payment
    participant Redis
    participant DB
    participant Kafka
    participant TossPayments

    Note over Frontend,TossPayments: ê²°ì œ ì¤€ë¹„ íë¦„
    Note over Frontend,Order: â€» ëª¨ë“  ìš”ì²­ì€ API Gateway(8000)ë¥¼ í†µí•´ ë¼ìš°íŒ…ë¨


    Frontend->>Order: POST /api/orders/prepare (ê²°ì œ ì¤€ë¹„ìš”ì²­)
    Order->>Redis: ì£¼ë¬¸ë²ˆí˜¸ ìƒì„±ìš”ì²­
    Redis->>Order: ì£¼ë¬¸ë²ˆí˜¸ ìƒì„± (yyyyMMdd00000001~)
    Order->>DB: ì£¼ë¬¸ ìƒì„± ìš”ì²­
    DB->>Order: ì£¼ë¬¸ ìƒì„±(CREATED)
    Order->>Kafka: product.information.request ì´ë²¤íŠ¸ ë°œí–‰
    Order->>Frontend: ì£¼ë¬¸ë²ˆí˜¸ ì‘ë‹µ

    loop ìµœëŒ€ 30ì´ˆê°„ í´ë§
        Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§(1request/sec)
        Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ
    end

    Kafka->>Product: product.information.request ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Product->>DB: ìƒí’ˆì •ë³´ ìš”ì²­
    DB->>Product: ìƒí’ˆì •ë³´ ì‘ë‹µ (ìƒí’ˆëª…, ê°€ê²©, ì¬ê³ )
    Product->>Kafka: product.information.response ì´ë²¤íŠ¸ ë°œí–‰

    Kafka->>Order: product.information.response ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>DB: ê²°ì œê¸ˆì•¡ ì €ì¥, ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ê²°ì œê¸ˆì•¡ ì €ì¥, ì£¼ë¬¸ìƒíƒœ ë³€ê²½(VALIDATION_SUCCESS)
    Order->>Kafka: payment.prepare ì´ë²¤íŠ¸ ë°œí–‰

    Kafka->>Payment: payment.prepare ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Payment->>DB: ê²°ì œì •ë³´ ì €ì¥ ìš”ì²­
    DB->>Payment: ê²°ì œì •ë³´ ì €ì¥
    Payment->>Kafka: payment.prepared ì´ë²¤íŠ¸ ë°œí–‰

    Kafka->>Order: payment.prepared ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>DB: PaymentId ë§µí•‘, ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: PaymentId ë§µí•‘, ì£¼ë¬¸ìƒíƒœ ë³€ê²½(PREPARED)



    Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§
    Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ(PREPARED)


    Frontend->>TossPayments: ê²°ì œ ìš”ì²­
    TossPayments->>Frontend: ê²°ì œ ì¤€ë¹„ ì™„ë£Œ
```


### 2. ì •ìƒ ì£¼ë¬¸ ì²˜ë¦¬ - ê²°ì œí™•ì •
```mermaid
sequenceDiagram autonumber
    participant Frontend
    participant Order
    participant Product
    participant Payment
    participant Redis
    participant DB
    participant Kafka
    participant TossPayments

    Note over Frontend,TossPayments: ê²°ì œ í™•ì • íë¦„
    Note over Frontend,Order: â€» ëª¨ë“  ìš”ì²­ì€ API Gateway(8000)ë¥¼ í†µí•´ ë¼ìš°íŒ…ë¨

    Frontend->>Order: POST /api/orders/confirm (ê²°ì œ í™•ì •ìš”ì²­)
    Order->>DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½(DECREASE_STOCK)
    Order->>Redis: PaymentKey ì €ì¥
    Order->>Kafka: product.stock.decrease ì´ë²¤íŠ¸ ë°œí–‰
    Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ


    loop ìµœëŒ€ 30ì´ˆê°„ í´ë§
        Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§(1request/sec)
        Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ
    end


    Kafka->>Product: product.stock.decrease ì´ë²¤íŠ¸ ìˆ˜ì‹ 

    Product->>Redis: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡ ì¡°íšŒ
    Redis->>Product: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡ ì‘ë‹µ
    rect rgba(205, 237, 151, 0.3)
        alt ê¸°ë¡ ì¡´ì¬í•¨ (ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­)
            Product->>Product: ì¬ê³ ì°¨ê° ìŠ¤í‚µ(return)
        else ê¸°ë¡ì—†ìŒ
          Product->>Redis: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡(ë©±ë“±ì²˜ë¦¬)
          Product->>DB: ì¬ê³ ì°¨ê° ìš”ì²­
          DB->>Product: ì¬ê³ ì°¨ê°
          Product->>Redis: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡ ì‚­ì œ
          Product->>Kafka: product.stock.decreased ì´ë²¤íŠ¸ ë°œí–‰
        end
    end

    Kafka->>Order: product.stock.decreased ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>Redis: PaymentKey ì¡°íšŒ
    Redis->>Order: PaymentKey ì‘ë‹µ
    Order->>DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½(PAYMENT_PENDING)
    Order->>Kafka: payment.pending ì´ë²¤íŠ¸ ë°œí–‰

    Kafka->>Payment: payment.pending ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Payment->>TossPayments: ê²°ì œìŠ¹ì¸ API í˜¸ì¶œ
    TossPayments->>Payment: ê²°ì œìŠ¹ì¸ ê²°ê³¼
    Payment->>DB: PaymentKeyë§µí•‘, ê²°ì œì •ë³´ ì €ì¥ ìš”ì²­
    DB->>Payment: PaymentKeyë§µí•‘, ê²°ì œì •ë³´ ì €ì¥
    Payment->>Kafka: payment.confirmed ì´ë²¤íŠ¸ ë°œí–‰

    Kafka->>Order: payment.confirmed ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>DB: ì£¼ë¬¸ìƒíƒœë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœë³€ê²½(CONFIRMED)

    Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§
    Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ(CONFIRMED)

    Note over Frontend: ì£¼ë¬¸ ì™„ë£Œ - ì‚¬ìš©ìì—ê²Œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ

```

---

### 3. ì£¼ë¬¸ ì‹¤íŒ¨ ì²˜ë¦¬
#### 3-1. ì¬ê³ ë¶€ì¡±

```mermaid
sequenceDiagram autonumber
    participant Frontend
    participant Order
    participant Product
    participant Payment
    participant Redis
    participant DB
    participant Kafka
    participant DLQ as Dead Letter Queue
    participant TossPayments

    Note over Frontend,TossPayments: ì¬ê³ ë¶€ì¡± ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤
    Note over Frontend,Order: â€» ëª¨ë“  ìš”ì²­ì€ API Gateway(8000)ë¥¼ í†µí•´ ë¼ìš°íŒ…ë¨

    Frontend->>TossPayments: ê²°ì œ ìš”ì²­
    TossPayments->>Frontend: ê²°ì œ ì¤€ë¹„ ì™„ë£Œ


    Frontend->>Order: POST /api/orders/confirm (ê²°ì œ í™•ì •ìš”ì²­)
    Order->>DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½(DECREASE_STOCK)
    Order->>Redis: PaymentKey ì €ì¥
    Order->>Kafka: product.stock.decrease ì´ë²¤íŠ¸ ë°œí–‰
    Order->>Frontend: ì£¼ë¬¸ë²ˆí˜¸ ì‘ë‹µ

    loop í´ë§ ì§€ì†
        Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§
        Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ(DECREASE_STOCK)
    end

    Kafka->>Product: product.stock.decrease ì´ë²¤íŠ¸ ìˆ˜ì‹ 

    Product->>Redis: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡ ì¡°íšŒ
    Product->>Redis: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡ ì‘ë‹µ

    alt ê¸°ë¡ ì¡´ì¬í•¨ (ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­)
        Product->>Product: ì¬ê³ ì°¨ê° ìŠ¤í‚µ(return)
    else ê¸°ë¡ì—†ìŒ
        Product->>Redis: ì¬ê³ ì°¨ê°ì‹œë„ ê¸°ë¡(ë©±ë“±ì²˜ë¦¬)
        Product->>DB: ì¬ê³  í™•ì¸ ìš”ì²­
        DB->>Product: ì¬ê³  í™•ì¸

        rect rgba(255, 182, 193, 0.3)
            Product->>Product: ì¬ê³  ë¶€ì¡± íŒì •
            Product->>DLQ: product.stock.decrease-dlt ì´ë²¤íŠ¸ ë°œí–‰
            Product->>Kafka: product.stock.decreased(success=fail) ì´ë²¤íŠ¸ ë°œí–‰
        end
    end

    Kafka->>Order: product.stock.decreased(success=fail) ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½(DECREASE_STOCK_FAILED)

    Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§
    Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ(DECREASE_STOCK_FAILED)

    Note over Frontend: ì‚¬ìš©ìì—ê²Œ "ì¬ê³  ë¶€ì¡±ìœ¼ë¡œ ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ
```

#### 3-2. ì”ì•¡ë¶€ì¡±

```mermaid
sequenceDiagram autonumber
    participant Frontend
    participant Order
    participant Product
    participant Payment
    participant Redis
    participant DB

    participant Kafka
    participant DLQ as Dead Letter Queue
    participant TossPayments

    Note over Frontend,TossPayments: ì¥ì• ìƒí™©2. ì”ì•¡ë¶€ì¡±
    Note over Frontend,Order: â€» ëª¨ë“  ìš”ì²­ì€ API Gateway(8000)ë¥¼ í†µí•´ ë¼ìš°íŒ…ë¨


    Frontend->>TossPayments: ê²°ì œ ìš”ì²­
    TossPayments->>Frontend: ê²°ì œ ì¤€ë¹„ ì™„ë£Œ


    Frontend ->> Order: POST /api/orders/confirm (ê²°ì œ í™•ì •ìš”ì²­)
    Order ->> DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½
    DB ->> Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­(DECREASE_STOCK)
    Order ->> Redis: PaymentKey ì €ì¥
    Order ->> Kafka: product.stock.decrease ì´ë²¤íŠ¸ ë°œí–‰
    Order ->> Frontend: ì£¼ë¬¸ë²ˆí˜¸ ì‘ë‹µ

    loop í´ë§ ì§€ì†
        Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§
        Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ(DECREASE_STOCK)
    end


    Kafka ->> Product: product.stock.decrease ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Product->>DB: ì¬ê³ ì°¨ê° ìš”ì²­
    DB->>Product: ì¬ê³ ì°¨ê°
    Product->>Kafka: product.stock.decreased ì´ë²¤íŠ¸ ë°œí–‰(success = true)


    Kafka ->> Order: product.stock.decreased ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>Redis: PaymentKey ì¡°íšŒ
    Redis->>Order: PaymentKey ì‘ë‹µ
    Order->>DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½(PAYMENT_PENDING)
    Order->>Kafka: payment.pending ì´ë²¤íŠ¸ ë°œí–‰


    Kafka->>Payment: payment.pending ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    rect rgba(255, 182, 193, 0.3)
      alt ì”ì•¡ë¶€ì¡±ìœ¼ë¡œ ê²°ì¬ì‹¤íŒ¨
          Payment->>TossPayments: ê²°ì œìŠ¹ì¸ API í˜¸ì¶œ
          TossPayments->>Payment: ê²°ì œì‹¤íŒ¨ ì‘ë‹µ
          Payment->>DB: ì¥ì• ë¡œê·¸ ì €ì¥ ìš”ì²­
          DB->>Payment: ì¥ì• ë¡œê·¸ ì €ì¥
          Payment->>DLQ:payment.pending-dlt ì´ë²¤íŠ¸ ë°œí–‰
          DLQ->>Payment:payment.pending-dlt ì´ë²¤íŠ¸ ì²˜ë¦¬
          Payment->>DB: ê²°ì œìƒíƒœ ìƒíƒœ ë³€ê²½ ë° ì‹¤íŒ¨ë¡œê·¸ ì €ì¥ ìš”ì²­
          DB->>Payment: ê²°ì œìƒíƒœ ìƒíƒœ ë³€ê²½ ë° ì‹¤íŒ¨ë¡œê·¸ ì €ì¥
          Payment->>Kafka: payment.confirmed.fail ì´ë²¤íŠ¸ ë°œí–‰
      end
    end

    Kafka->>Order: payment.confirmed.fail ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Order->>DB: ì£¼ë¬¸ìƒíƒœ ë³€ê²½ ìš”ì²­
    DB->>Order: ì£¼ë¬¸ìƒíƒœ ë³€ê²½(PAYMENT_FAILED)


    Frontend->>Order: ì£¼ë¬¸ìƒíƒœ í´ë§
    Order->>Frontend: ì£¼ë¬¸ìƒíƒœ ì‘ë‹µ(PAYMENT_FAILED)
    Note over Frontend: ì‚¬ìš©ìì—ê²Œ "ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤" ë©”ì‹œì§€ í‘œì‹œ

    Note over Frontend,TossPayments: ë³´ìƒíŠ¸ëœì­ì…˜ - ì¬ê³ ë¡¤ë°± ì´ë²¤íŠ¸
    Order->>Kafka: product.stock.rollback ì´ë²¤íŠ¸ ë°œí–‰
    Kafka->>Product: product.stock.rollback ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    Product->>Redis: ì¬ê³ ë³µêµ¬ì‹œë„ ê¸°ë¡ ì¡°íšŒ
    Redis->>Product: ì¬ê³ ë³µêµ¬ì‹œë„ ê¸°ë¡ ì‘ë‹µ

    rect rgba(205, 237, 151, 0.3)
        alt ê¸°ë¡ ì¡´ì¬í•¨ (ì´ë¯¸ ì²˜ë¦¬ëœ ìš”ì²­)
            Product->>Product: ì¬ê³ ë³µêµ¬ ìŠ¤í‚µ(return)
        else ê¸°ë¡ì—†ìŒ
            Product->>Redis: ì¬ê³ ë³µêµ¬ì‹œë„ ê¸°ë¡(ì¤‘ë³µ ì¬ê³  ë³µêµ¬ë¥¼ ìœ„í•œ ë©±ë“±ì²˜ë¦¬)
            Product->>DB: ì¬ê³  ë³µêµ¬ ìš”ì²­
            DB->>Product: ì¬ê³  ë³µêµ¬
            Product->>Redis: ì¬ê³ ë³µêµ¬ì‹œë„ ê¸°ë¡ ì‚­ì œ
            alt ì¬ê³  ë³µêµ¬ ì‹¤íŒ¨
                Product->>DLQ: ì‹¤íŒ¨ì´ë²¤íŠ¸ ì €ì¥(ë¡œê¹…)
            end
        end
    end
```
